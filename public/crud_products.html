<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Product Management</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 2rem;
				max-width: 900px;
			}
			h1 {
				margin-bottom: 1.5rem;
			}
			.section {
				margin-bottom: 2rem;
			}
			form {
				display: grid;
				gap: 1rem;
				max-width: 400px;
				padding: 1rem;
				border: 1px solid #ccc;
				border-radius: 4px;
			}
			label {
				display: flex;
				flex-direction: column;
				font-weight: 600;
			}
			input {
				padding: 0.5rem;
				font-size: 1rem;
				margin-top: 0.25rem;
			}
			button {
				padding: 0.6rem;
				font-size: 1rem;
				cursor: pointer;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 4px;
			}
			button:hover {
				background-color: #0056b3;
			}
			.status {
				margin-top: 1rem;
				font-weight: 600;
			}
			.error {
				color: #b00020;
			}
			.success {
				color: #006400;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 1rem;
			}
			table th,
			table td {
				border: 1px solid #ddd;
				padding: 0.75rem;
				text-align: left;
			}
			table th {
				background-color: #f4f4f4;
				font-weight: 600;
			}
			.actions {
				display: flex;
				gap: 0.5rem;
			}
			.btn-edit,
			.btn-delete {
				padding: 0.4rem 0.8rem;
				font-size: 0.9rem;
				cursor: pointer;
				border: none;
				border-radius: 4px;
			}
			.btn-edit {
				background-color: #28a745;
				color: white;
			}
			.btn-edit:hover {
				background-color: #218838;
			}
			.btn-delete {
				background-color: #dc3545;
				color: white;
			}
			.btn-delete:hover {
				background-color: #c82333;
			}
			.hidden {
				display: none;
			}
			.nav-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1.5rem;
			}
			.nav-link {
				padding: 0.6rem 1rem;
				background-color: #007bff;
				color: white;
				text-decoration: none;
				border-radius: 4px;
				font-weight: 600;
			}
			.nav-link:hover {
				background-color: #0056b3;
			}
		</style>
	</head>
	<body>
		<div class="nav-header">
			<h1>Product Management (CRUD)</h1>
			<a href="/chat" class="nav-link">Go to Chat</a>
		</div>

		<div class="section">
			<h2 id="form-title">Create Product</h2>
			<form id="product-form">
				<input type="hidden" id="product-id" />
				<label>
					Product name
					<input id="name" name="name" type="text" required />
				</label>
				<label>
					Price (per 1/2 unit)
					<input id="price" name="price" type="number" min="0" step="0.01" required />
				</label>
				<button type="submit" id="form-submit-btn">Save</button>
				<button type="button" id="cancel-btn" class="hidden">Cancel</button>
			</form>
			<p id="status" class="status"></p>
		</div>

		<div class="section">
			<h2>Products List</h2>
			<table id="products-table">
				<thead>
					<tr>
						<th>ID</th>
						<th>Name</th>
						<th>Price (1/2 unit)</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody id="products-tbody">
					<tr>
						<td colspan="4" style="text-align: center;">Loading...</td>
					</tr>
				</tbody>
			</table>
		</div>

		<script>
			const form = document.getElementById('product-form');
			const formTitle = document.getElementById('form-title');
			const productIdInput = document.getElementById('product-id');
			const nameInput = document.getElementById('name');
			const priceInput = document.getElementById('price');
			const submitBtn = document.getElementById('form-submit-btn');
			const cancelBtn = document.getElementById('cancel-btn');
			const statusEl = document.getElementById('status');
			const tbody = document.getElementById('products-tbody');

			let isEditMode = false;

			async function loadProducts() {
				try {
					const response = await fetch('/products');
					const data = await response.json();
					renderProducts(data.items || []);
				} catch (error) {
					tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #b00020;">Failed to load products.</td></tr>';
				}
			}

			function renderProducts(products) {
				if (products.length === 0) {
					tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No products found.</td></tr>';
					return;
				}

				tbody.innerHTML = products
					.map(
						(product) => `
					<tr>
						<td>${product.id}</td>
						<td>${escapeHtml(product.name)}</td>
						<td>$${product.price_half_quantity.toFixed(2)}</td>
						<td class="actions">
							<button class="btn-edit" onclick="editProduct(${product.id}, '${escapeHtml(product.name)}', ${product.price_half_quantity})">Edit</button>
							<button class="btn-delete" onclick="deleteProduct(${product.id})">Delete</button>
						</td>
					</tr>
				`
					)
					.join('');
			}

			function escapeHtml(text) {
				const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
				return text.replace(/[&<>"']/g, (m) => map[m]);
			}

			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				statusEl.textContent = isEditMode ? 'Updating...' : 'Saving...';
				statusEl.className = 'status';

				const payload = {
					name: nameInput.value.trim(),
					price_half_quantity: parseFloat(priceInput.value),
				};

				if (!payload.name) {
					statusEl.textContent = 'Name is required.';
					statusEl.classList.add('error');
					return;
				}

				if (Number.isNaN(payload.price_half_quantity) || payload.price_half_quantity <= 0) {
					statusEl.textContent = 'Price must be a number greater than zero.';
					statusEl.classList.add('error');
					return;
				}

				try {
					let response;
					if (isEditMode) {
						const productId = productIdInput.value;
						response = await fetch(`/products/${productId}`, {
							method: 'PUT',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload),
						});
					} else {
						response = await fetch('/products', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(payload),
						});
					}

					const result = await response.json();

					if (response.ok) {
						statusEl.textContent = isEditMode ? 'Product updated successfully.' : 'Product saved successfully.';
						statusEl.classList.add('success');
						form.reset();
						resetForm();
						loadProducts();
					} else {
						statusEl.textContent = result.detail || 'There was an error processing the request.';
						statusEl.classList.add('error');
					}
				} catch (error) {
					statusEl.textContent = 'Could not reach the server.';
					statusEl.classList.add('error');
				}
			});

			function editProduct(id, name, price) {
				isEditMode = true;
				productIdInput.value = id;
				nameInput.value = name;
				priceInput.value = price.toFixed(2);
				formTitle.textContent = 'Edit Product';
				submitBtn.textContent = 'Update';
				cancelBtn.classList.remove('hidden');
				statusEl.textContent = '';
				statusEl.className = 'status';
			}

			cancelBtn.addEventListener('click', () => {
				form.reset();
				resetForm();
			});

			function resetForm() {
				isEditMode = false;
				productIdInput.value = '';
				formTitle.textContent = 'Create Product';
				submitBtn.textContent = 'Save';
				cancelBtn.classList.add('hidden');
				statusEl.textContent = '';
				statusEl.className = 'status';
			}

			async function deleteProduct(id) {
				if (!confirm('Are you sure you want to delete this product?')) {
					return;
				}

				try {
					const response = await fetch(`/products/${id}`, {
						method: 'DELETE',
					});

					const result = await response.json();

					if (response.ok) {
						loadProducts();
					} else {
						alert(result.detail || 'Failed to delete product.');
					}
				} catch (error) {
					alert('Could not reach the server.');
				}
			}

			loadProducts();
		</script>
	</body>
</html>
